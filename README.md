# DLS1-Fall2025-FaceRecProject
DLS1 Fall 2025 Graduate Project (Face Recognition)

# Проект: Распознавание лиц (Face Recognition)

<img width="590" height="590" alt="3" src="https://github.com/user-attachments/assets/27384ca7-a606-461c-835a-eda139f22077" />

Реализован пайплайн для распознавания лиц, включающий три ключевых этапа: **детекцию лица**, **выравнивание по ключевым точкам (face alignment)** и непосредственно **распознавание личности (face recognition)**.

## Содержание

1.  [Архитектура системы](#архитектура-системы)
2.  [Обучение моделей](#обучение-моделей)
    -   [Модель предсказания ключевых точек для выравнивания лица (Face Alignment)](#модель-предсказания-ключевых-точек-для-выравнивания-лица-face-alignment)
    -   [Модель распознавания лиц (Face Recognition)](#модель-распознавания-лиц-face-recognition)
3.  [Веб-интерфейс](#веб-интерфейс)
4.  [Результаты](#результаты)

---

## Архитектура системы

Пайплайн состоит из трех последовательных модулей:

1.  **Детекция лица (Face Detection)**: Используется предобученная модель InsightFace (`buffalo_l`) для обнаружения и кадрирования всех лиц на входном изображении произвольного размера.

   <img width="790" height="555" alt="6" src="https://github.com/user-attachments/assets/86ec9ecd-1378-446e-aa0e-35956381e813" />

2.  **Выравнивание лица (Face Alignment)**: На основе архитектуры **Stacked Hourglass** построена и обучена модель для предсказания 5 ключевых точек лица (глаза, нос, уголки рта) на кадрированном изображении лица произвольного размера. Модель вычисляет такие точки для каждого обнаруженного лица, и далее они используются для аффинного преобразования (`warpAffine` OpenCV), которое выравнивает лицо по горизонтали (линия глаз) и центрирует его вокруг носа. Изображение лица на данном этапе приводится к размеру 256х256 для подачи на вход следующей модели.
 
   <img width="790" height="419" alt="2" src="https://github.com/user-attachments/assets/49caed5c-32b0-4590-a874-5ce25f1b6df4" />

3.  **Распознавание лиц (Face Recognition)**: Обучена модель на основе **ResNet18** (с предобучением на наборе данных ImageNet) с использованием слоя **ArcFace**. В режиме инференса модель принимает на вход выровненное изображение лица размером 256x256 и вычисляет для него 512-мерный эмбеддинг-вектор. Такие вектора могут использоваться, в частности, для установления идентичности лица на разных изображениях.

<img width="945" height="200" alt="7" src="https://github.com/user-attachments/assets/d01462f6-d1ec-4fb7-a95b-e62dffbeb7c0" />

---

## Обучение моделей

<img width="543" height="435" alt="4" src="https://github.com/user-attachments/assets/4b3a5a48-0fd5-43eb-a234-72a36909bbe8" />

### Модель предсказания ключевых точек для выравнивания лица (Face Alignment)

*   **Датасет**: Для обучения использовался датасет [CelebA Original Wild](https://www.kaggle.com/datasets/kevinpatel04/celeba-original-wild-images). В результате фильтрации получена выборка из 20,000 изображений (1000 уникальных классов/личностей), стратифицированных по 4 половозрастным когортам (male/female х young / not young) и аксессуарам / лицевой растительности.
*   **Архитектура**: Stacked Hourglass Network для предсказания 5 ключевых точек (левый зрачок, правый зрачок, кончик носа, левый угол рта, правый угол рта; стороны определяются относительно их положения на мониторе). На данный момент доступны веса для конфигурации с 2 стеками и 4 модулями.
*   **Метрика**: Целевая метрика, использованная при обучении, -- нормализованная средняя ошибка (NME). Лучший результат на валидации — **3.07%**.
  
*Использованные наборы данных и файл с метаданными доступны по ссылкам в разделе "Результаты" блокнота "DLS1 FR - 1. FaceAlignment". Веса обученной модели доступны по ссылке в подразделе "Предобученные модели" ниже.*

<img width="1962" height="796" alt="1" src="https://github.com/user-attachments/assets/49d6d3d2-b1f5-4866-a471-8673241e0ad2" />

### Модель распознавания лиц (Face Recognition)

*   **Датасет**: Обучение проводилось на том же отфильтрованном датасете CelebA (20,000 изображений, 1000 классов) за исключением отложенной (тестовой) выборки в размере 1999 изображений (100 классов).
*   **Базовая модель**: ResNet18 с предобученными на ImageNet весами, до выхода слоя AvgPool (512-мерный тензор). Используется как feature extractor.
*   **Функция потерь**: Сравнивались два подхода:
    *   **Cross-Entropy Loss (CE)**: Acc@1 = **80.58%** на валидации. Выход опорной архитектуры (backbone) подается на вход эмбеддинг-слою, а оттуда -- полносвязному слою-классификатору.
    *   **ArcFace -> CE loss**: Acc@1 = **83.42%** на валидации. Выход опорной архитектуры подается на вход ArcFace-слою.

*Отложенный набор данных в виде csv-файла доступен по ссылке в разделе "Результаты" блокнота "DLS1 FR - 2. ArcFace". Веса обученных моделей доступны по ссылкам в подразделе "Предобученные модели" ниже.*

<img width="1168" height="788" alt="5" src="https://github.com/user-attachments/assets/2c01d685-9d57-4ed5-b58a-98c262d6d947" />

---

## Веб-интерфейс

На данном этапе веб-интерфейс отсутствует. Решение совместимо с векторными базами данных вида FAISS, Qdrant, LanceDB и др.

---

## Предобученные модели (веса)
*   **1. Модель предсказания ключевых точек (Landmark Detection -> Face Alignment)**: [`lm_detection_model.pth`](https://drive.google.com/file/d/1RQyIhEkl8oe67E98Zk3i0gymUbZb3Voi/view?usp=drive_link)
*   **2.1. Модель вычисления эмбеддинга лица (Face Recognition, бэйзлайн-реализация)**: [`ce_loss_baseline_model (best_model.pth).pth`](https://drive.google.com/file/d/1JS-qiBff163-0wTMQJ08hkGtQnWxzWgb/view?usp=drive_link)
*   **2.2. Модель вычисления эмбеддинга лица (Face Recognition, реализация с ArcFace)**: [`face_embedding_model.pth`](https://drive.google.com/file/d/1L03l0xK10sHChe42NKfMkLG4dgn7Qx7X/view?usp=drive_link)

---

## Результаты

Поставленные задачи успешно выполнены. Ход работы и результаты выполнения отдельных задач и подзадач детально описаны в соответствующих файлах:
1. **[DLS1 FR - 1. FaceAlignment](https://github.com/airbourne211/DLS1-Fall2025-FaceRecProject/blob/main/DLS1_FR_1_FaceAlignment.ipynb)**:
   1) фильтрация исходного набора данных;
   2) реализация и обучение модели StackedHourglass;
   3) предобработка набора (кадрирование по "ббоксам" и выравнивание по предсказанным ключевым точкам).
2. **[DLS1 FR - 2. ArcFace](https://github.com/airbourne211/DLS1-Fall2025-FaceRecProject/blob/main/DLS1_FR_2_ArcFace.ipynb)**:
   1) формирование отложенного (тестового) набора данных;
   2) реализация и обучение бэйзлайн-модели на основе ResNet18;
   3) реализация и обучение модели на основе ResNet18 с интеграцией слоя ArcFace.
3. **[DLS1 FR - 3. FaceRec Inference Pipeline](https://github.com/airbourne211/DLS1-Fall2025-FaceRecProject/blob/main/DLS1_FR_3_FaceRec_Inference_Pipeline.ipynb)**:
   1) сборка пайплайна распознавания лиц: от произвольного изображения до сравнения эмбеддингов.

<img width="974" height="590" alt="8" src="https://github.com/user-attachments/assets/ca023a96-55c2-4859-815b-5ff418d2c011" />
